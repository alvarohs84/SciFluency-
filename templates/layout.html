<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>{{ app_name }}</title>
<style>
:root { --bg: #f8faff; --card: #fff; --text: #333; --subtext: #7f8c8d; --accent: #0088cc; --border: #e1e8ed; --input: #fff; --heat-0: #ecf0f1; --heat-1: #a8e6cf; --heat-2: #55efc4; --heat-3: #00b894; --shadow: rgba(0,0,0,0.03); }
body.dark-mode { --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --subtext: #b0b0b0; --accent: #4fc3f7; --border: #333; --input: #2c2c2c; --heat-0: #2c2c2c; --heat-1: #1e3a2f; --heat-2: #2e7d62; --heat-3: #00b894; --shadow: rgba(0,0,0,0.5); }
body{font-family:'Segoe UI',sans-serif;background:var(--bg);margin:0;padding-bottom:180px;color:var(--text); transition: background 0.3s;}
.header{background:var(--card);padding:18px;border-bottom:1px solid var(--border);display:flex;align-items:center;position:sticky;top:0;z-index:1000; justify-content: space-between;}
.container{padding:20px;max-width:650px;margin:0 auto;}
.sidebar{height:100%;width:0;position:fixed;top:0;left:0;background:var(--card);overflow-x:hidden;transition:0.3s;padding-top:60px;z-index:2000;box-shadow:2px 0 100px rgba(0,0,0,0.2);}
.sidebar a{padding:15px 25px;text-decoration:none;font-size:1.1rem;color:var(--text);display:block;border-bottom:1px solid var(--border);}
.sub-text {display:block;font-size:0.85rem;color:var(--subtext);font-weight:normal;margin-top:3px;}
.sidebar a span{display:block;font-size:0.8rem;color:var(--subtext);margin-top:2px;}
.card{background:var(--card);padding:20px;margin-bottom:15px;border-radius:16px;border:1px solid var(--border);box-shadow:0 4px 10px var(--shadow);}
.btn{background:var(--accent);color:#fff;border:none;padding:12px 20px;border-radius:25px;font-weight:bold;cursor:pointer;}
.sentence-block{padding:18px;margin-bottom:12px;border-left:5px solid transparent;cursor:pointer;background:var(--card);border-radius:8px;}
.k-sent { cursor: pointer; transition: background-color 0.2s; padding: 2px 0; border-radius: 4px; }
.k-sent:hover { background-color: #e1f5fe; color: #000; }
.word-active { background-color: #ffeb3b !important; color: #000; box-shadow: 0 0 5px #ffeb3b; }
.player{position:fixed;bottom:0;left:0;width:100%;background:var(--card);border-top:1px solid var(--border);padding:20px;z-index:1500;display:flex;flex-direction:column;gap:10px;align-items:center;}
.controls-row{display:flex;gap:15px;align-items:center;}
input,textarea,select{width:100%;padding:12px;margin-bottom:10px;border:1px solid var(--border);border-radius:10px; background:var(--input); color:var(--text);}
.sys-box{background:var(--bg);padding:10px;border-radius:8px;margin-bottom:10px;}
.hub-card{text-align:center;padding:20px;cursor:pointer;}.hub-card:hover{filter:brightness(0.95);}
.badge {background:#ff7675;color:white;padding:2px 8px;border-radius:12px;font-size:0.8rem;margin-left:5px;}
.srs-btn {flex:1; border:none; padding:15px; border-radius:12px; font-weight:bold; cursor:pointer; color:#444;}
.modal-actions { display: flex; gap: 5px; }
.checker-box { display: flex; flex-direction: column; gap: 10px; }
.checker-label { font-weight: bold; color: var(--subtext); font-size: 0.9rem; margin-bottom: 5px; display: block;}
.text-area-box { width: 100%; padding: 15px; border-radius: 12px; border: 1px solid var(--border); font-family: inherit; font-size: 1rem; line-height: 1.5; resize: vertical; min-height: 120px; box-sizing: border-box; background:var(--input); color:var(--text); }
.corrected-box { border: 1px solid #2ecc71; background: #f0fdf4; color: #14532d; }
.arrow-separator { text-align: center; font-size: 1.5rem; color: var(--accent); margin: 5px 0; }
.save-form { margin-top: 15px; padding: 15px; background: var(--bg); border: 1px dashed #2ecc71; border-radius: 10px; }
.fab { position: fixed; bottom: 90px; right: 20px; width: 56px; height: 56px; background: var(--accent); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; z-index: 1400; transition: transform 0.2s; user-select: none; }
.fab:active { transform: scale(0.95); }
.mic-btn-active { background-color: #e74c3c !important; animation: pulse 1.5s infinite; }
@keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); } 100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); } }
.dash-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
.stat-card { background: var(--card); padding: 15px; border-radius: 12px; text-align: center; box-shadow: 0 2px 5px var(--shadow); }
.stat-val { font-size: 1.8rem; font-weight: bold; color: var(--accent); }
.stat-lbl { font-size: 0.8rem; color: var(--subtext); text-transform: uppercase; letter-spacing: 1px; }
.heatmap { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 10px; }
.heat-day { aspect-ratio: 1; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; color: #555; }
.cloze-blank { border-bottom: 2px solid var(--accent); color: transparent; background: #e3f2fd; padding: 0 5px; border-radius: 3px; }
.cloze-reveal .cloze-blank { color: var(--accent); background: transparent; font-weight: bold; }
.modal { display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
.modal form { background-color: var(--card); margin: 15% auto; padding: 25px; border: 1px solid var(--border); width: 85%; max-width: 400px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); color: var(--text); position: relative; }
.word-row { display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--border); padding:10px 0; }

.word-span { transition: 0.1s; border-bottom: 1px dotted transparent; }
body.mode-read .word-span { pointer-events: none; } 
body.mode-read .k-sent { cursor: pointer; }
body.mode-mine .k-sent { pointer-events: none; }
body.mode-mine .word-span { pointer-events: auto; cursor: context-menu; border-bottom: 2px dotted #e67e22; color: #d35400; }
body.mode-mine .word-span:hover { background: #f39c12; color: white; border-radius: 3px; }

/* QUIZ STYLES */
.quiz-hidden { background: #f1c40f; color: transparent; border-radius: 4px; padding: 0 5px; cursor: pointer; user-select: none; border-bottom: 2px solid #d35400; font-size: 0.9em; min-width: 30px; display: inline-block; text-align: center; }
.quiz-hidden:hover { background: #f39c12; }
.quiz-revealed { background: transparent; color: #2ecc71; font-weight: bold; border-bottom: none; animation: pop 0.3s ease; }
@keyframes pop { 0% { transform: scale(0.8); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
</style>
<script>
let curAud=null, sentSpans=[], aFrm=null, rate=1.0, acc='com', cumWeights=[];
function openNav(){document.getElementById("side").style.width="280px";}
function closeNav(){document.getElementById("side").style.width="0";}
function toggleTheme() { document.body.classList.toggle('dark-mode'); const isDark = document.body.classList.contains('dark-mode'); localStorage.setItem('theme', isDark ? 'dark' : 'light'); document.getElementById('themeIcon').innerText = isDark ? 'â˜€ï¸' : 'ğŸŒ™'; }
window.onload = () => { document.body.classList.add('mode-read'); if(localStorage.getItem('theme') === 'dark') { document.body.classList.add('dark-mode'); if(document.getElementById('themeIcon')) document.getElementById('themeIcon').innerText = 'â˜€ï¸'; } };

async function speak(txt){ 
    if(curAud) { curAud.pause(); curAud = null; } 
    const cleanTxt = txt.replace(/<[^>]*>/g, "").replace(/\[|\]/g, "").replace(/'/g, ""); 
    const btn = document.getElementById('playBtn'); btn.innerText='â³'; 
    try { 
        const response = await fetch('/tts', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: 'text=' + encodeURIComponent(cleanTxt) + '&accent=' + acc }); 
        if (!response.ok) throw new Error('Network response was not ok'); 
        const blob = await response.blob(); 
        const url = URL.createObjectURL(blob); 
        curAud = new Audio(url); 
        curAud.playbackRate = rate; 
        
        curAud.onloadedmetadata = () => { 
            let totalChars = 0;
            let weights = sentSpans.map(span => { let len = span.innerText.length; totalChars += len; return len; });
            let current = 0; cumWeights = weights.map(w => { current += w; return (current / totalChars); });
            curAud.play(); btn.innerText='â¸'; loop(); 
        }; 
        curAud.onended = () => { btn.innerText='â–¶'; cancelAnimationFrame(aFrm); document.querySelectorAll('.word-active').forEach(w=>w.classList.remove('word-active')); }; 
    } catch (error) { console.error("TTS Error:", error); btn.innerText='âš ï¸'; } 
}

function togglePlay(){ if(!curAud) return; const btn=document.getElementById('playBtn'); if(curAud.paused){ curAud.play(); btn.innerText='â¸'; loop(); } else{ curAud.pause(); btn.innerText='â–¶'; cancelAnimationFrame(aFrm); } }
function prepare(el,txt){ if(curAud){curAud.pause(); cancelAnimationFrame(aFrm);} document.querySelectorAll('.word-active').forEach(w=>w.classList.remove('word-active')); sentSpans = Array.from(el.querySelectorAll('.k-sent')); let textToRead = txt; if(sentSpans.length > 0) { textToRead = sentSpans.map(s => s.innerText).join(" "); } speak(textToRead); }
function wordClick(e, word) { e.stopPropagation(); if(curAud) { curAud.pause(); document.getElementById('playBtn').innerText='â–¶'; cancelAnimationFrame(aFrm); } openAdd(word); }
function loop(){ if(!curAud || curAud.paused) return; if(curAud.duration > 0){ const p = curAud.currentTime / curAud.duration; let idx = cumWeights.findIndex(t => t >= p); if(idx === -1) idx = cumWeights.length - 1; document.querySelectorAll('.word-active').forEach(w => w.classList.remove('word-active')); if(sentSpans[idx]) sentSpans[idx].classList.add('word-active'); } aFrm = requestAnimationFrame(loop); }
function openAdd(w){ document.getElementById("mod").style.display="block"; const inp = document.getElementById("fIn"); inp.value = w; inp.removeAttribute('readonly'); fetchTranslation(w); }
function fetchTranslation(w) { fetch('/traduzir_palavra?w='+w).then(r=>r.json()).then(d=>document.getElementById('bIn').value=d.t); }
function refreshTrans() { const w = document.getElementById("fIn").value; fetchTranslation(w); }
function openManualAdd() { closeNav(); document.getElementById("mod").style.display="block"; document.getElementById("fIn").value=""; document.getElementById("fIn").removeAttribute('readonly'); document.getElementById("fIn").placeholder="Type in PT or EN (Auto-Translate)..."; }
function nextWord() { if(wordPool.length > 0) { const w = wordPool[Math.floor(Math.random() * wordPool.length)]; document.getElementById('targetWord').innerText = w.w; document.getElementById('targetIPA').innerText = w.ipa; document.getElementById('feedbackBox').innerHTML = "Tap mic & speak..."; document.getElementById('micBtn').style.background = "var(--accent)"; document.getElementById('micBtn').classList.remove('mic-btn-active'); } }

function toggleMiner() {
    document.body.classList.toggle('mode-read');
    document.body.classList.toggle('mode-mine');
    const btn = document.getElementById('modeBtn');
    if(document.body.classList.contains('mode-mine')) {
        btn.innerHTML = 'â›ï¸ MINING MODE';
        btn.style.background = '#e67e22';
    } else {
        btn.innerHTML = 'ğŸ“– READING MODE';
        btn.style.background = '#3498db';
    }
}
function mineWord(e, w) { e.stopPropagation(); openAdd(w); }
function submitAjax(e) {
    e.preventDefault();
    const f = e.target;
    const btn = f.querySelector('button');
    const originalText = btn.innerText;
    btn.innerText = "Saving...";
    fetch('/adicionar_vocab', {
        method: 'POST',
        body: new URLSearchParams(new FormData(f)) + '&ajax=1',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
    }).then(r=>r.json()).then(d=>{
        btn.innerText = "Saved! âœ…";
        setTimeout(()=>{
            document.getElementById('mod').style.display='none';
            btn.innerText = originalText;
        }, 800);
    });
}

// QUIZ LOGIC
function loadQuiz(containerId, textContent) {
    const btn = document.getElementById('quizBtn_' + containerId);
    btn.innerText = "â³ Generating...";
    fetch('/get_quiz', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: 'text=' + encodeURIComponent(textContent)
    }).then(r => r.json()).then(data => {
        const box = document.getElementById('quizBox_' + containerId);
        box.innerHTML = data.html;
        box.style.display = 'block';
        box.scrollIntoView({behavior: "smooth"});
        btn.innerText = "ğŸ”„ Regenerate Quiz";
    });
}
function reveal(el, word) {
    el.classList.remove('quiz-hidden');
    el.classList.add('quiz-revealed');
    el.innerText = word;
}
</script></head><body>
<div id="side" class="sidebar">
    <a href="javascript:void(0)" onclick="closeNav()" style="text-align:right;font-size:2rem;padding-right:20px;">&times;</a>
    <a href="javascript:void(0)" onclick="toggleTheme()">ğŸŒ™ Dark Mode / Light Mode</a>
    <a href="/">ğŸ“š Play Deck <span>Estudar CartÃµes</span></a>
    <a href="/tutor">ğŸ‘©â€ğŸ« AI Tutor <span>Tutor Reverso</span></a>
    <a href="/vocab_list">ğŸ—‚ï¸ My Vocabulary <span>Gerenciar Palavras</span></a>
    <a href="/search">ğŸ” PubMed Search <span>Busca de Artigos</span></a>
    <a href="/summarizer">âš¡ Smart Summarizer <span>Resumidor Inteligente</span></a>
    <a href="/pronunciation">ğŸ¤ Pronunciation <span>Treino de Fala</span></a>
    <a href="/checker">ğŸ“ Grammar & Style <span>Corretor AcadÃªmico</span></a>
    <a href="javascript:void(0)" onclick="openManualAdd()">â• Add Custom Term <span>Adicionar Termo</span></a>
    <a href="/systems">ğŸ§© Language Lab <span>Sistemas LinguÃ­sticos</span></a>
    <a href="/hub">ğŸŒ Research Hub <span>Bases de Dados</span></a>
    <a href="/phrases">ğŸ“– Phrasebank <span>Banco de Frases</span></a>
    <a href="/miner">â›ï¸ Data Miner <span>Minerador de Dados</span></a>
    <a href="/novo">âœ¨ Read & Speak <span>Leitura e Fala</span></a>
    <a href="javascript:void(0)" onclick="if(confirm('Isso apaga TUDO. Certeza?')){window.location.href='/reset_decks'}" style="color:#d63031;border-top:1px solid #eee;margin-top:20px;">âš ï¸ Factory Reset <span>Restaurar PadrÃ£o</span></a>
</div>
<div class="header">
    <span onclick="openNav()" style="font-size:1.5rem;cursor:pointer;">â˜°</span>
    <h3 style="margin-left:20px; flex:1;">{{ app_name }}</h3>
    <span id="themeIcon" onclick="toggleTheme()" style="font-size:1.5rem;cursor:pointer;">ğŸŒ™</span>
</div>

{% if mode == 'list' %}
<div class="container">
    <div class="dash-row"><div class="stat-card"><div class="stat-val">{{ stats.total }}</div><div class="stat-lbl">Words</div></div><div class="stat-card"><div class="stat-val" style="color:#27ae60;">{{ stats.mastered }}</div><div class="stat-lbl">Mastered</div></div></div>
    <div class="card" style="padding:15px;"><div class="stat-lbl" style="text-align:left; margin-bottom:10px;">Activity (Last 14 days)</div><div class="heatmap">{% for day in stats.heatmap %}<div class="heat-day" style="background:{{day.color}}" title="{{day.date}}: {{day.count}}">{{day.day}}</div>{% endfor %}</div></div>
    <h3>Study Time</h3>{% for d in decks %}<a href="/jogar/{{d.id}}" style="text-decoration:none;color:inherit;"><div class="card" style="text-align:center; border:2px solid var(--accent);"><div style="font-size:3rem">{{d.icon}}</div><b>{{d.name}}</b><br><span class="sub-text">Tap to Review</span><br>{% if d.due_count > 0 %}<span class="badge" style="font-size:1rem; padding:5px 15px; margin-top:5px; display:inline-block;">{{d.due_count}} cards due</span>{% else %}<small style="color:var(--subtext)">All done!</small>{% endif %}</div></a>{% endfor %}
</div>

{% elif mode == 'checker' %}
<div class="container"><h3>ğŸ“ Grammar & Style</h3><form action="/checker" method="POST"><div class="checker-box"><label class="checker-label">Original Text (Draft)</label><textarea name="text_input" class="text-area-box" placeholder="Paste your text here (English)..." style="height:120px;">{{original}}</textarea></div><div class="arrow-separator">â¬‡ï¸ IMPROVE & POLISH â¬‡ï¸</div><button class="btn" style="width:100%; margin-bottom: 20px;">CHECK GRAMMAR</button><div class="checker-box"><label class="checker-label">Corrected Version (Academic)</label><textarea readonly id="correctedText" class="text-area-box corrected-box" style="height:120px;">{{corrected}}</textarea></div></form>{% if corrected %}<div style="margin-top:10px; display:flex; gap:10px;"><button class="btn" style="background:#34495e; flex:1;" onclick="speak(document.getElementById('correctedText').value)">ğŸ”Š LISTEN</button><button class="btn" style="background:#27ae60; flex:1;" onclick="navigator.clipboard.writeText(document.getElementById('correctedText').value); alert('Copied!')">ğŸ“‹ COPY</button></div>{% endif %}</div>
{% elif mode == 'tutor' %}
<div class="container"><h3>ğŸ‘©â€ğŸ« AI Tutor</h3><form action="/tutor" method="POST"><div class="checker-box"><label class="checker-label">Type in PT or EN (Auto-Detect):</label><textarea name="pt_text" class="text-area-box" placeholder="Ex: Eu preciso enviar os resultados..." style="height:100px;">{{res.pt if res else ''}}</textarea><button class="btn" style="width:100%; margin-top:10px;">TEACH ME</button></div></form>{% if res %}<div class="card" style="margin-top:20px; border-left:5px solid var(--accent);"><div class="sentence-block" style="border:none; padding:0; line-height:1.6;" onclick='prepare(this, {{ res.en|tojson }})'><span class='k-sent' style="font-size:1.2rem; font-weight:bold; cursor:pointer;">{{res.en}}</span><p style="color:var(--accent); font-weight:bold; margin-top:10px; cursor:pointer; text-align:center;">â–¶ TAP TO READ & LISTEN</p></div><div style="color:var(--subtext); margin-top:10px;">{{res.pt}}</div></div><h4 style="margin-top:20px;">Vocabulary Breakdown</h4><div class="card">{% for v in res.vocab %}<form action="/adicionar_vocab" method="POST" class="word-row"><div style="flex:1;"><b>{{v.word}}</b> <span style="color:var(--accent); font-family:monospace; font-size:0.8rem;">{{v.ipa}}</span><br><small style="color:var(--subtext)">{{v.trans}}</small></div><input type="hidden" name="f" value="{{v.word}}"><input type="hidden" name="b" value="{{v.trans}}"><input type="hidden" name="context" value="{{res.en}}"><div style="display:flex; gap:10px;"><button type="button" class="btn" style="padding:5px 10px; font-size:0.8rem;" onclick="speak('{{v.word}}')">ğŸ”Š</button><button class="btn" style="background:#27ae60; padding:5px 10px; font-size:0.8rem;">â•</button></div></form>{% endfor %}</div>{% endif %}</div>
{% elif mode == 'vocab_list' %}
<div class="container"><h3>My Vocabulary</h3><div style="display:flex; justify-content:flex-end; gap:10px; margin-bottom:15px;"><a href="/export_vocab" class="btn" style="background:#8e44ad; text-decoration:none; font-size:0.8rem;">ğŸ“¥ Export</a><form action="/import_vocab" method="POST" enctype="multipart/form-data" style="display:inline;"><label for="csvUpload" class="btn" style="background:#2980b9; cursor:pointer; font-size:0.8rem;">ğŸ“¤ Import</label><input type="file" id="csvUpload" name="csv_file" style="display:none;" onchange="this.form.submit()"></form></div><div class="card">{% for c in cards %}<div class="word-row"><div><b>{{c.front}}</b> <span style="color:var(--accent); font-family:monospace; font-size:0.8rem;">{{c.ipa}}</span><br><small style="color:var(--subtext)">{{c.back}}</small></div><div style="display:flex; gap:10px;"><button class="btn" style="padding:5px 10px; font-size:0.8rem;" onclick="speak('{{c.front}}')">ğŸ”Š</button><a href="/delete_card/{{c.id}}" class="btn" style="background:#e74c3c; padding:5px 10px; font-size:0.8rem; text-decoration:none;">ğŸ—‘ï¸</a></div></div>{% else %}<p style="text-align:center; color:var(--subtext);">No words saved yet.</p>{% endfor %}</div></div>
{% elif mode == 'search' %}
<div class="container"><h3>PubMed Search</h3><form action="/search" method="POST"><div class="checker-box"><input type="text" name="query" placeholder="e.g. 'Cancer AND Therapy'..." value="{{query}}"><button class="btn" style="width:100%;">SEARCH</button></div></form>{% if results %}{% for r in results %}<div class="card" style="margin-top:15px;"><b style="color:var(--accent);">{{r.journal}}</b><h4>{{r.title}}</h4><div style="max-height:80px; overflow:hidden; text-overflow:ellipsis; color:var(--subtext); font-size:0.9rem;">{{r.abstract}}</div><form action="/summarizer" method="POST" style="margin-top:10px;"><input type="hidden" name="text_input" value="{{r.abstract}}"><input type="hidden" name="title_input" value="{{r.title}}"><button class="btn" style="background:#27ae60; font-size:0.8rem; padding:8px 15px;">âš¡ PROCESS ABSTRACT</button></form></div>{% endfor %}{% endif %}</div>
{% elif mode == 'summarizer' %}
<div class="container"><h3>Smart Summarizer</h3><form action="/summarizer" method="POST" enctype="multipart/form-data"><div class="card"><label class="checker-label">Upload Batch (NBIB/RIS)</label><input type="file" name="nbib_file" accept=".nbib,.ris,.txt" style="margin-bottom:10px;"><p style="color:var(--subtext); font-size:0.8rem; margin-top:0;">âš ï¸ Warning: Limits to first 5 articles.</p><div class="arrow-separator" style="font-size:1rem; margin:10px 0;">OR</div><label class="checker-label">Paste Text</label><textarea name="text_input" class="text-area-box" style="height:100px;" placeholder="Paste text here..."></textarea><button class="btn" style="width:100%; margin-top:15px;">PROCESS</button></div></form>{% if batch_results %}{% for res in batch_results %}<div class="card" style="margin-top:20px;"><button id="modeBtn" class="btn" style="width:100%; margin-bottom:10px; background:#3498db;" onclick="toggleMiner()">ğŸ“– READING MODE</button><h4 style="margin:0 0 10px 0;">{{res.title}}</h4><div class="sentence-block" style="border:none; padding:0; line-height:1.6;" onclick='prepare(this, {{ res.clean_text|tojson }})'>{{ res.formatted_html | safe }}<p style="color:var(--accent); font-weight:bold; margin-top:10px; cursor:pointer; text-align:center;">â–¶ TAP TO READ & LISTEN</p></div><button id="quizBtn_{{loop.index}}" class="btn" style="width:100%; margin-top:15px; background:#8e44ad;" onclick='loadQuiz("{{loop.index}}", {{ res.clean_text|tojson }})'>ğŸ§© TEST ME (Generate Quiz)</button><div id="quizBox_{{loop.index}}" style="display:none; margin-top:15px; padding:15px; background:var(--input); border:2px dashed #8e44ad; border-radius:10px; line-height:2;"></div><details style="margin-top:10px; border-top:1px solid var(--border); padding-top:10px;"><summary style="cursor:pointer; color:var(--accent); font-weight:bold;">ğŸ‡§ğŸ‡· Ver TraduÃ§Ã£o</summary><p style="margin-top:10px; color:var(--text); line-height:1.5;">{{ res.translation }}</p></details></div>{% endfor %}{% endif %}</div>
{% elif mode == 'study_play' %}
<div class="container">{% if card %}<div class="card" style="text-align:center;padding:30px;"><small>{{deck.name}}</small>{% if card.is_cloze %}<h1 id="wordTxt" class="cloze-content">{{ card.cloze_hint }}</h1><p style="color:var(--subtext);font-style:italic;">Complete the sentence</p>{% else %}<h1 id="wordTxt">{{card.front}}</h1><p style="color:var(--accent);font-family:monospace;">{{card.ipa}}</p>{% endif %}<div id="ansBox" style="display:none;margin-top:20px;border-top:1px dashed #ccc;padding-top:20px;">{% if card.is_cloze %}<h2 style="color:#2ecc71;">{{card.front}}</h2><small style="display:block;margin-top:5px;color:var(--subtext);">Translation: {{card.back}}</small>{% else %}<h2 style="color:#2ecc71;">{{card.back}}</h2>{% endif %}{% if card.context %}<div style="margin-top:10px; padding:10px; background:#e1f5fe; border-radius:8px; font-style:italic; font-size:0.9rem;">ğŸ’¡ "{{card.context}}"</div>{% endif %}<div style="display:flex; gap:10px; margin-top:20px;"><button class="srs-btn" style="background:var(--hard);" onclick="submitRating('hard', '{{deck.id}}', '{{card.front}}')">Hard</button><button class="srs-btn" style="background:var(--med);" onclick="submitRating('medium', '{{deck.id}}', '{{card.front}}')">Good</button><button class="srs-btn" style="background:var(--easy);" onclick="submitRating('easy', '{{deck.id}}', '{{card.front}}')">Easy</button></div></div></div><div style="display:flex;flex-direction:column;gap:10px;"><button class="btn" onclick="speak('{{card.front}}')">ğŸ“¢ LISTEN</button><button class="btn" style="background:#34495e" onclick="document.getElementById('ansBox').style.display='block'">SHOW ANSWER</button><a href="/jogar/{{deck.id}}" class="btn" style="background:#f1c40f; color:#333; text-align:center; text-decoration:none;">â­ Pular / PrÃ³xima</a></div>{% else %}<div class="card" style="text-align:center;padding:40px;"><h3>ğŸ‰ All caught up!</h3><p>No due cards.</p><a href="/add_random/{{deck.id}}" class="btn" style="background:#ff9f43;">ğŸ² ADD RANDOM</a></div>{% endif %}</div>
{% elif mode == 'pronunciation' %}
<div class="container"><h3>Pronunciation Lab</h3><div class="card" style="text-align:center; padding:40px;"><h1 id="targetWord" style="font-size:2.5rem; margin-bottom:10px; color:var(--text);">...</h1><p id="targetIPA" style="color:var(--accent); font-family:monospace; font-size:1.5rem; margin-top:0;">/ipa/</p><div id="feedbackBox" style="margin:20px 0; min-height:50px; font-weight:bold; font-size:1.1rem; color:var(--subtext);">Tap the mic and say the word.</div><button id="micBtn" class="fab" style="position:relative; bottom:auto; right:auto; width:80px; height:80px; font-size:2rem; box-shadow:0 4px 15px rgba(52, 152, 219, 0.4);" onclick="toggleRec()">ğŸ¤</button><div style="margin-top:30px; display:flex; gap:10px; justify-content:center;"><button class="btn" style="background:var(--input); color:var(--text); border:1px solid var(--border);" onclick="speak(document.getElementById('targetWord').innerText)">ğŸ”Š Listen</button><button class="btn" style="background:var(--card); color:var(--text); border:1px solid var(--border);" onclick="nextWord()">ğŸ² Next Word</button></div></div><script>const wordPool = {{ words_json | safe }}; const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition; let recognition; function nextWord() { if(wordPool.length > 0) { const w = wordPool[Math.floor(Math.random() * wordPool.length)]; document.getElementById('targetWord').innerText = w.w; document.getElementById('targetIPA').innerText = w.ipa; document.getElementById('feedbackBox').innerHTML = "Tap mic & speak..."; document.getElementById('micBtn').style.background = "var(--accent)"; document.getElementById('micBtn').classList.remove('mic-btn-active'); } } if (SpeechRecognition) { recognition = new SpeechRecognition(); recognition.lang = 'en-US'; recognition.continuous = false; recognition.onstart = () => { document.getElementById('micBtn').classList.add('mic-btn-active'); document.getElementById('feedbackBox').innerText = "Listening..."; }; recognition.onend = () => { document.getElementById('micBtn').classList.remove('mic-btn-active'); }; recognition.onresult = (event) => { const spoken = event.results[0][0].transcript.toLowerCase().trim(); const target = document.getElementById('targetWord').innerText.toLowerCase().trim(); const confidence = Math.round(event.results[0][0].confidence * 100); const cleanSpoken = spoken.replace(/[^\\w\\s]/gi, ''); const cleanTarget = target.replace(/[^\\w\\s]/gi, ''); if (cleanSpoken === cleanTarget) { document.getElementById('feedbackBox').innerHTML = `<span style="color:#27ae60; font-size:1.4rem;">âœ… Perfect!</span><br><small>Confidence: ${confidence}%</small>`; new Audio('https://actions.google.com/sounds/v1/cartoon/pop.ogg').play(); } else { document.getElementById('feedbackBox').innerHTML = `<span style="color:#e74c3c; font-size:1.4rem;">âŒ Try again</span><br>You said: "<b>${spoken}</b>"`; } }; recognition.onerror = (event) => { document.getElementById('feedbackBox').innerText = "Error: " + event.error; }; } else { document.getElementById('feedbackBox').innerHTML = "âš ï¸ Browser not supported. Use Chrome."; } function toggleRec() { if(recognition) recognition.start(); else alert("Browser not supported"); } nextWord();</script></div>
{% elif mode == 'systems' %}
<div class="container"><h3>Language Lab</h3><form action="/systems" method="POST"><input type="text" name="word" placeholder="Type a word..."><button class="btn" style="width:100%">ANALYZE</button></form>{% if analysis %}<div class="card" style="margin-top:20px;"><div style="display:flex;justify-content:space-between;align-items:center;"><h2 style="margin:0;">{{analysis.word}}</h2><button class="btn" style="padding:10px 15px;" onclick="speak('{{analysis.word}}')">ğŸ”Š</button></div><p style="color:var(--accent); font-family:monospace; font-size:1.2rem;">{{analysis.ipa}}</p><div class="sys-box"><b>ğŸ‡§ğŸ‡· Translation:</b><br>{{analysis.trans}}</div><div class="sys-box"><b>ğŸ§© Morphology:</b><br>{% for p in analysis.morph %}{{p|safe}}<br>{% else %}No common roots found.{% endfor %}</div></div>{% endif %}</div>
{% elif mode == 'hub' %}
<div class="container"><h3 style="text-align:center;">Research Hub</h3><div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">{% for link in links %}<div class="card hub-card" onclick="window.open('{{link.url}}','_blank')"><div style="font-size:2.5rem;">{{link.icon}}</div><b>{{link.name}}</b><br><small>{{link.desc}}</small></div>{% endfor %}</div></div>
{% elif mode == 'phrases' %}
<div class="container">
    <h3>Phrasebank</h3>
    <p style="font-size:0.9rem; color:var(--subtext);">Tap any phrase to listen and practice (Karaoke enabled).</p>
    
    {% for sec, list_phrases in phrases.items() %}
    <div class="card">
        <div class="section-header" style="background:#eef2f3; padding:10px; border-radius:8px; margin-bottom:10px; font-weight:bold; color:var(--accent);">
            {{sec}}
        </div>
        {% for p in list_phrases %}
        <div class="sentence-block" onclick="prepare(this, '{{p.en}}')">
            {% for w in p.en.split() %}
            <span class="k-sent">{{w}}</span> 
            {% endfor %}
            <br>
            <small style="color:var(--subtext); font-style:italic;">{{p.pt}}</small>
        </div>
        {% endfor %}
    </div>
    {% endfor %}
</div>
{% elif mode == 'miner_home' %}
<div class="container"><form action="/miner" method="POST" enctype="multipart/form-data"><div class="card"><h3>â›ï¸ Data Miner</h3><label style="display:block;margin-bottom:10px;color:var(--subtext);">Suporta: PDF, TXT, RIS, NBIB</label><input type="file" name="arquivo_upload" multiple accept=".pdf,.txt,.ris,.nbib"><textarea name="texto_full" style="height:100px;margin-top:10px;" placeholder="Ou cole o texto aqui..."></textarea><button class="btn" style="width:100%">EXTRACT</button></div></form></div>
{% elif mode == 'miner_res' %}
<div class="container">{% for w, c in keywords %}<div style="display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid var(--border);background:var(--card);"><span><b>{{w}}</b> ({{c}})</span><button class="btn" onclick="openAdd('{{w}}')">â•</button></div>{% endfor %}</div>
{% elif mode == 'read' %}
<div class="container">
    <div class="card" style="text-align:center; background:#f3e5f5; border:1px solid #9b59b6; margin-bottom: 20px;">
        <h3 style="margin:0 0 10px 0; color: #8e44ad;">ğŸ§ Sci-Podcast</h3>
        <p style="font-size:0.9rem; color:#555;">Transform this text into an audio episode.</p>
        <a href="/podcast/{{story.id}}" class="btn" style="background:#8e44ad; width:100%; display:block; box-sizing:border-box; text-decoration:none;">DOWNLOAD MP3</a>
    </div>
    {% for s in story.sentences %}
    <div class="sentence-block" onclick="prepare(this,'{{s.en}}')"><b>{{s.en}}</b><br><small>{{s.pt}}</small></div>
    {% endfor %}
</div>
{% elif mode == 'new' %}
<div class="container"><form action="/processar" method="POST" enctype="multipart/form-data"><div class="card"><h3>New Reading</h3><label>Upload (PDF, TXT, RIS, NBIB):</label><input type="file" name="arquivo_upload" accept=".pdf,.txt,.ris,.nbib"><textarea name="texto_full" placeholder="Or paste text here..." style="height:150px; margin-top:10px;"></textarea><button class="btn" style="width:100%">PROCESS</button></div></form></div>
{% endif %}

<div class="fab" onclick="openManualAdd()">â•</div>
<div class="player"><div class="controls-row"><button id="playBtn" class="btn" style="border-radius:50%;width:50px;" onclick="togglePlay()">â–¶</button><select onchange="acc=this.value"><option value="com">ğŸ‡ºğŸ‡¸</option><option value="co.uk">ğŸ‡¬ğŸ‡§</option></select><input type="range" min="0.5" max="1.5" step="0.1" value="1.0" oninput="rate=this.value"></div></div>
<div id="mod" class="modal" style="display:none;"><form action="/adicionar_vocab" method="POST" onsubmit="submitAjax(event)"><h3 style="margin-top:0">Save to My Vocabulary</h3><div class="modal-actions"><input type="text" id="fIn" name="term" placeholder="Type in PT or EN (Auto-Translate)..." style="width:100%"></div><button class="btn" style="margin-top:10px;">SAVE</button><button type="button" class="btn" style="background:#888;margin-top:10px;" onclick="document.getElementById('mod').style.display='none'">CLOSE</button></form></div>
</body></html>
