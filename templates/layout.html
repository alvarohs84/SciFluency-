<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="theme-color" content="#0984e3">
<title>{{ app_name }}</title>
<link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
<link rel="icon" type="image/png" href="{{ url_for('static', filename='icon.png') }}">
<link rel="apple-touch-icon" href="{{ url_for('static', filename='icon.png') }}">

<style>
:root { --p: #0984e3; --s: #2d3436; --bg: #f5f6fa; --card: #fff; --h: #ffeaa7; --w: #6c5ce7; --t: #00b894; --ipa: #e84393; }
body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--s); margin: 0; padding-bottom: 100px; }
.header { background: var(--card); padding: 15px; display: flex; justify-content: space-between; border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 100; align-items: center; }
.container { padding: 20px; max-width: 1200px; margin: 0 auto; } /* Largura aumentada para o Writer */

/* Sidebar */
.sidebar { height: 100%; width: 0; position: fixed; top: 0; left: 0; background: var(--card); overflow-x: hidden; transition: 0.3s; padding-top: 60px; z-index: 200; box-shadow: 2px 0 100px rgba(0,0,0,0.2); }
.sidebar a { padding: 12px 25px; text-decoration: none; font-size: 0.95rem; color: var(--s); display: block; border-bottom: 1px solid #eee; }
.sidebar-head { font-size: 0.75rem; font-weight: bold; color: #999; padding: 15px 25px 5px; margin-top: 15px; border-bottom: 2px solid #eee; text-transform: uppercase; }

/* Componentes Gerais */
.card { background: var(--card); padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 15px; }
.btn { background: var(--p); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; text-decoration: none; display: inline-block; text-align: center; }
.btn-sm { padding: 5px 10px; font-size: 0.8rem; }
.ipa-tag { color: var(--p); font-family: 'Courier New', monospace; font-size: 0.9rem; margin-left: 5px; background: #eef2f3; padding: 2px 5px; border-radius: 4px; }

/* --- ESTILOS DO WRITER (NOVO) --- */
.writer-layout { display: grid; grid-template-columns: 1fr; gap: 20px; height: 80vh; }
.paper-container { display: flex; flex-direction: column; height: 100%; }
.paper { 
    flex: 1; 
    width: 100%; 
    padding: 40px; 
    border: 1px solid #ddd; 
    border-radius: 5px; 
    font-family: 'Georgia', serif; 
    line-height: 1.8; 
    font-size: 1.1rem; 
    resize: none; 
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    outline: none;
}
.phrasebank { 
    background: white; 
    border-left: 1px solid #eee; 
    padding: 15px; 
    overflow-y: auto; 
    border-radius: 10px; 
    max-height: 80vh;
}
.phrase-category { font-weight: bold; margin-top: 15px; color: var(--p); border-bottom: 1px solid #eee; padding-bottom: 5px; }
.phrase-item { 
    padding: 8px; 
    border-bottom: 1px solid #f0f0f0; 
    cursor: pointer; 
    font-size: 0.9rem; 
    transition: 0.2s;
}
.phrase-item:hover { background: #e1f5fe; color: var(--p); }
.phrase-pt { display: block; font-size: 0.8rem; color: #777; margin-top: 2px; }

/* Leitura e Modais */
.sentence-block { padding: 15px; margin-bottom: 10px; cursor: pointer; line-height: 1.8; border-radius: 8px; transition: 0.1s; }
.sentence-active { background: #e1f5fe; border-left: 5px solid var(--p); }
.word-span:hover { background: #fdcb6e; border-radius: 3px; }
.word-active { background: var(--h) !important; color: black; box-shadow: 0 0 8px var(--h); border-radius: 3px; font-weight: bold; }
.modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 300; align-items: center; justify-content: center; }
.modal-content { background: var(--card); padding: 25px; border-radius: 10px; width: 90%; max-width: 600px; text-align: center; }
.fab { position: fixed; bottom: 80px; right: 20px; width: 60px; height: 60px; background: var(--p); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 1400; cursor: pointer; }
textarea, input { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-family: inherit; }

/* Desktop Mode */
@media (min-width: 992px) {
    .sidebar { width: 280px !important; }
    .header, .container { margin-left: 280px; }
    .header span { display: none; }
    .fab { right: 40px; }
    /* No PC, o Writer fica lado a lado */
    .writer-layout { grid-template-columns: 2fr 1fr; }
}
</style>
<script>
let curAud=null, currentSpans=[], karaokeTimeout=null, rate=1.0;
function openNav(){document.getElementById("side").style.width="280px";}
function closeNav(){document.getElementById("side").style.width="0";}
function toggleModal(id){const m=document.getElementById(id); m.style.display=(m.style.display=='flex')?'none':'flex';}

// --- FUNÃ‡Ã•ES DO WRITER ---
function insertPhrase(text) {
    const area = document.getElementById('thesisPaper');
    const start = area.selectionStart;
    const end = area.selectionEnd;
    
    // Insere o texto onde o cursor estÃ¡
    area.value = area.value.substring(0, start) + text + area.value.substring(end);
    
    // Coloca o cursor no final do texto inserido e foca
    area.selectionStart = area.selectionEnd = start + text.length;
    area.focus();
}

async function speak(text){ 
    if(curAud) { curAud.pause(); curAud = null; } 
    if(karaokeTimeout) clearTimeout(karaokeTimeout);
    document.querySelectorAll('.word-active').forEach(w=>w.classList.remove('word-active'));
    const btn = document.getElementById('playBtn'); if(btn) btn.innerText='â³';
    const cleanTxt = text.replace(/<[^>]*>/g, "").replace(/\[|\]/g, "");
    try {
        const res = await fetch('/tts', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: 'text=' + encodeURIComponent(cleanTxt) + '&accent=com' }); 
        const blob = await res.blob(); curAud = new Audio(URL.createObjectURL(blob)); curAud.playbackRate = rate; 
        curAud.onloadedmetadata = () => { if(btn) btn.innerText='â–¶'; curAud.play(); if(currentSpans.length > 0) startWeightedKaraoke(curAud.duration); }; 
        curAud.onended = () => { if(karaokeTimeout) clearTimeout(karaokeTimeout); document.querySelectorAll('.word-active').forEach(w=>w.classList.remove('word-active')); }; 
    } catch(e) { console.error(e); }
}
function startWeightedKaraoke(duration) {
    let weights = currentSpans.map(s => s.innerText.length);
    let totalTime = (duration * 1000) / rate;
    let timePerChar = totalTime / weights.reduce((a,b)=>a+b, 0);
    let index = 0;
    function next() {
        if (index >= currentSpans.length) return;
        if (index > 0) currentSpans[index-1].classList.remove('word-active');
        currentSpans[index].classList.add('word-active');
        let delay = weights[index] * timePerChar;
        index++; karaokeTimeout = setTimeout(next, delay);
    }
    next();
}
function prepare(el){
    if(curAud) curAud.pause();
    document.querySelectorAll('.sentence-active').forEach(s => s.classList.remove('sentence-active'));
    el.classList.add('sentence-active');
    currentSpans = Array.from(el.querySelectorAll('.word-span'));
    speak(el.innerText);
}
function mineWord(e, w) {
    e.stopPropagation(); if(curAud) curAud.pause();
    document.getElementById("dictModal").style.display = "flex";
    document.getElementById("dictWord").innerText = w;
    document.getElementById("dictTrans").innerText = "Translating...";
    document.getElementById("dictIPA").innerText = "...";
    fetch('/traduzir_palavra?w='+w).then(r=>r.json()).then(d=>{ document.getElementById("dictTrans").innerText = d.t; document.getElementById("dictIPA").innerText = d.ipa; document.getElementById("saveF").value = w; });
}
function saveCard() {
    const w = document.getElementById("saveF").value;
    const fd = new FormData(); fd.append('term', w);
    fetch('/adicionar_vocab', {method:'POST', body:fd}).then(()=>{ document.getElementById("dictModal").style.display='none'; alert("Saved (Salvo)!"); });
}
function playDict() { speak(document.getElementById("dictWord").innerText); }
function startRec(target) {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition; if(!SR) return alert("Use Chrome");
    const r = new SR(); r.lang='en-US';
    document.getElementById('mic').classList.add('mic-active');
    r.onresult=(e)=>{
        const s = e.results[0][0].transcript.toLowerCase().replace(/[^a-z]/g,'');
        const t = target.toLowerCase().replace(/[^a-z]/g,'');
        document.getElementById('fb').innerHTML = (s==t) ? "âœ… PERFECT!" : "âŒ Heard: " + s;
        document.getElementById('mic').classList.remove('mic-active');
    };
    r.start();
}
function openCitation(id) {
    const m = document.getElementById('citeModal'); m.style.display = 'flex';
    ['citABNT','citAPA','citVAN','citAMA','citHAR','citIEEE','citCHI'].forEach(i => document.getElementById(i).innerHTML = "Generating...");
    fetch('/get_citation/' + id).then(r => r.json()).then(d => {
        document.getElementById('citABNT').innerHTML = d.abnt; document.getElementById('citAPA').innerHTML = d.apa;
        document.getElementById('citVAN').innerHTML = d.vancouver; document.getElementById('citAMA').innerHTML = d.ama;
        document.getElementById('citHAR').innerHTML = d.harvard; document.getElementById('citIEEE').innerHTML = d.ieee;
        document.getElementById('citCHI').innerHTML = d.chicago;
    });
}
function copyText(el) {
    navigator.clipboard.writeText(el.innerText);
    const original = el.style.backgroundColor; el.style.backgroundColor = "#dff9fb";
    setTimeout(() => { el.style.backgroundColor = original; }, 200);
    alert("Copied (Copiado)!");
}
</script>
</head>
<body>

<div id="side" class="sidebar">
    <a href="javascript:void(0)" onclick="closeNav()" style="text-align:right;font-size:2em;padding-right:20px;">&times;</a>
    <a href="/">ğŸ  Home (InÃ­cio)</a>
    
    <div class="sidebar-head">STUDY & TOOLS (ESTUDO)</div>
    <a href="/novo">âœ¨ New Text (Novo Texto)</a>
    <a href="/pronunciation">ğŸ¤ Pronunciation (PronÃºncia)</a>
    <a href="/vocab_list">ğŸ—‚ï¸ Vocabulary (VocabulÃ¡rio)</a>
    <a href="/search">ğŸ” PubMed Search (Busca)</a>
    <a href="/checker">ğŸ“ Grammar Checker (Corretor)</a>
    <a href="/miner">â›ï¸ Data Miner (Minerador)</a>
    <a href="/summarizer">âš¡ Summarizer (Resumidor)</a>
    
    <div class="sidebar-head">RESEARCH (PESQUISA)</div>
    <a href="/library">ğŸ“š Reference Manager (Gestor)</a>
    <a href="/writer">âœï¸ Writer (Redator)</a>
</div>

<div class="header"><span onclick="openNav()" style="font-size:1.5em;cursor:pointer;">â˜°</span><h3>{{ app_name }}</h3></div>

{% if mode == 'writer' %}
<div class="container" style="max-width:100%;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h3>Thesis Writer (Redator AcadÃªmico)</h3>
        <button class="btn btn-sm" onclick="alert('Funcionalidade de ExportaÃ§Ã£o em Breve!')">ğŸ’¾ Export .DOCX</button>
    </div>
    
    <div class="writer-layout">
        <div class="paper-container">
            <textarea id="thesisPaper" class="paper" placeholder="Start writing your thesis here... (Comece a escrever sua tese aqui...)"></textarea>
        </div>

        <div class="phrasebank">
            <h4 style="margin-top:0; border-bottom:2px solid var(--p); padding-bottom:10px;">Academic Phrasebank (Banco de Frases)</h4>
            <p style="font-size:0.8rem; color:#777;">Click to insert (Clique para inserir)</p>
            
            {% for category, phrases in connectors.items() %}
                <div class="phrase-category">{{ category }}</div>
                {% for p in phrases %}
                    <div class="phrase-item" onclick="insertPhrase('{{ p.en }} ')">
                        {{ p.en }}
                        <span class="phrase-pt">{{ p.pt }}</span>
                    </div>
                {% endfor %}
            {% endfor %}
        </div>
    </div>
</div>

{% elif mode == 'dashboard' %}
<div class="container">
    <h3>Dashboard (Painel)</h3>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
        <div class="card" onclick="window.location.href='/novo'" style="border-left:5px solid var(--p); cursor:pointer;"><b>ğŸ“– Study (Estudar)</b><br><small>Text/PDF</small></div>
        <div class="card" onclick="window.location.href='/library'" style="border-left:5px solid var(--w); cursor:pointer;"><b>ğŸ“š References (ReferÃªncias)</b><br><small>Manager (Gestor)</small></div>
        <div class="card" onclick="window.location.href='/search'" style="border-left:5px solid var(--t); cursor:pointer;"><b>ğŸ” PubMed (Busca)</b><br><small>Search Articles</small></div>
        <div class="card" onclick="window.location.href='/vocab_list'" style="border-left:5px solid var(--h); cursor:pointer;"><b>ğŸ—‚ï¸ Vocab (VocabulÃ¡rio)</b><br><small>Review ({{stats.vocab}})</small></div>
        <div class="card" onclick="window.location.href='/writer'" style="border-left:5px solid #e17055; cursor:pointer;"><b>âœï¸ Writer (Redator)</b><br><small>Escreva sua Tese</small></div>
    </div>
</div>

{% elif mode == 'library' %}
<div class="container"><h3>Reference Manager (Gestor de ReferÃªncias)</h3>
<div class="card" style="background:#e1f5fe; border:1px dashed var(--p);">
    <form action="/library" method="POST" enctype="multipart/form-data">
        <label style="display:block; margin-bottom:5px;"><b>Add Files (Adicionar Arquivos)</b></label>
        <input type="file" name="ref_files" multiple accept=".pdf,.ris,.nbib,.txt">
        <button class="btn" style="width:100%; margin-top:10px;">Upload Selected (Enviar)</button>
        <small style="color:#666;">Accepts: PDF, RIS, NBIB, TXT</small>
    </form>
</div>
{% for r in references %}
<div class="card">
    <b>{{r.title}}</b><br><small>{{r.authors}} ({{r.year}})</small>
    {% if r.url %}<br><a href="{{r.url}}" target="_blank" style="color:var(--p); font-size:0.9rem;">ğŸ”— Original Link</a>{% endif %}
    <div style="margin-top:10px; display:flex; gap:5px;">
        <a href="/read_ref/{{r.id}}" class="btn btn-sm">Study (Estudar)</a>
        <button class="btn btn-sm" onclick="openCitation({{r.id}})" style="background:#f39c12;">â Cite (Citar)</button>
        <a href="/delete_ref/{{r.id}}" class="btn btn-sm" style="background:#e74c3c;">X</a>
    </div>
</div>{% endfor %}</div>

{% elif mode == 'search' %}
<div class="container">
    <h3>PubMed Search (Busca)</h3>
    <form action="/search" method="POST">
        <div style="display:flex; gap:5px;">
            <input type="text" name="query" value="{{query}}" placeholder="Ex: diabetes..." required>
            <button class="btn">ğŸ”</button>
        </div>
        <div style="margin-top:10px; display:flex; gap:15px; font-size:0.9rem; color:#555;">
            <label style="display:flex; align-items:center; gap:5px; cursor:pointer;"><input type="checkbox" name="f_abstract" value="1" {% if f_abstract %}checked{% endif %}> Has Abstract (Com Resumo)</label>
            <label style="display:flex; align-items:center; gap:5px; cursor:pointer;"><input type="checkbox" name="f_free" value="1" {% if f_free %}checked{% endif %}> Free Full Text (GrÃ¡tis)</label>
        </div>
    </form>
    
    <div style="margin-top:20px;">
        {% for r in results %}
        <div class="card">
            <div style="display:flex; justify-content:space-between;">
                <span style="background:#e1f5fe; color:var(--p); padding:2px 8px; border-radius:4px; font-size:0.8rem; font-weight:bold;">{{r.journal}}</span>
                <small style="color:#999;">PMID: {{r.pmid}}</small>
            </div>
            <h4 style="margin:10px 0;">{{r.title}}</h4>
            <p style="font-size:0.9rem; color:#555; display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden;">{{r.abstract}}</p>
            <div style="margin-top:15px; display:flex; gap:10px;">
                <a href="{{r.url}}" target="_blank" class="btn btn-sm" style="background:#2d3436;">â†— View (Ver)</a>
                <a href="/import_pubmed/{{r.pmid}}" class="btn btn-sm" style="background:var(--t);">+ Add to Manager (Salvar)</a>
            </div>
        </div>
        {% else %}
            {% if query %}<p style="text-align:center; margin-top:20px;">End of results (Fim).</p>{% endif %}
        {% endfor %}
    </div>

    {% if results or start > 0 %}
    <div style="display:flex; justify-content:center; gap:10px; margin-top:20px;">
        {% if start > 0 %}
        <a href="/search?query={{query}}&start={{start - 10}}&f_abstract={{f_abstract}}&f_free={{f_free}}" class="btn" style="background:#b2bec3;">â¬… Previous (Anterior)</a>
        {% endif %}
        {% if results|length == 10 %}
        <a href="/search?query={{query}}&start={{start + 10}}&f_abstract={{f_abstract}}&f_free={{f_free}}" class="btn">Next (PrÃ³xima) â¡</a>
        {% endif %}
    </div>
    {% endif %}
</div>

{% elif mode == 'vocab_list' %}
<div class="container"><h3>My Flashcards (VocabulÃ¡rio)</h3>{% for c in cards %}<div class="card" style="display:flex; justify-content:space-between; align-items:center;">
<div onclick="speak('{{c.front}}')" style="cursor:pointer; flex:1;"><b style="font-size:1.1rem;">{{c.front}}</b><span class="ipa-tag">{{c.ipa}}</span><br><small style="color:#777;">({{c.back}})</small></div>
<button class="btn btn-sm" onclick="speak('{{c.front}}')">ğŸ”Š</button></div>{% else %}<p>No words (Vazio).</p>{% endfor %}</div>

{% elif mode == 'new' %}
<div class="container"><div class="card"><h3>Add Material (Novo Material)</h3><form action="/novo" method="POST" enctype="multipart/form-data"><textarea name="text_input" rows="5" placeholder="Paste text here... (Cole o texto)"></textarea><p>OR PDF (OU PDF):</p><input type="file" name="file_input"><button class="btn" style="width:100%">PROCESS & STUDY (PROCESSAR)</button></form></div></div>

{% elif mode == 'read' %}
<div class="container"><h3>{{ story.title }}</h3>{% for s in story.sentences %}<div class="sentence-block" onclick="prepare(this)">{% for w in s.en.split() %}<span class="word-span" onclick="mineWord(event, '{{w|replace("'","")|replace(".","")}}')">{{w}}</span> {% endfor %}<br><small style="color:#7f8c8d">({{ s.pt }})</small></div>{% endfor %}</div>

{% elif mode == 'pronunciation' %}
<div class="container" style="text-align:center;"><script>const words={{ words_json | safe }};</script><div class="card" style="padding:40px;"><h1 id="pWord">Ready?</h1><p id="pIpa" style="color:var(--p); font-family:monospace; font-size:1.2rem;">...</p><button id="mic" class="mic-btn" onclick="startRec(document.getElementById('pWord').innerText)">ğŸ¤</button><h3 id="fb">Tap & Speak (Fale)</h3><button class="btn" onclick="let w=words[Math.floor(Math.random()*words.length)]; document.getElementById('pWord').innerText=w.w; document.getElementById('pIpa').innerText=w.ipa;">Next (PrÃ³xima)</button></div></div>

{% elif mode == 'checker' %}
<div class="container"><h3>Grammar Checker (Corretor)</h3><form action="/checker" method="POST"><textarea name="text_input" rows="5">{{original}}</textarea><button class="btn">Fix (Corrigir)</button></form>{% if corrected %}<div class="card" style="background:#e1f5fe;">{{corrected|safe}}</div>{% endif %}</div>

{% elif mode == 'miner' %}
<div class="container"><h3>Data Miner (Minerador)</h3><form action="/miner" method="POST" enctype="multipart/form-data"><textarea name="text_input" placeholder="Paste text... (Cole texto)"></textarea><input type="file" name="file_input"><button class="btn">Extract (Extrair)</button></form>{% for k,v in keywords %}<div class="card" style="padding:10px;"><b>{{k}}</b>: {{v}}x</div>{% endfor %}</div>

{% elif mode == 'summarizer' %}
<div class="container"><h3>Summarizer (Resumidor)</h3><form action="/summarizer" method="POST" enctype="multipart/form-data"><textarea name="text_input" placeholder="Text... (Texto)"></textarea><input type="file" name="file_input"><button class="btn">Summarize (Resumir)</button></form></div>
{% endif %}

<div class="fab" onclick="window.location.href='/novo'">+</div>
<div id="dictModal" class="modal"><div class="modal-content"><h2 id="dictWord">...</h2><p id="dictIPA" style="color:var(--p);">...</p><p id="dictTrans">...</p><div style="display:flex; gap:10px; justify-content:center;"><button class="btn" onclick="playDict()">ğŸ”Š</button><button class="btn" onclick="saveCard()" style="background:#27ae60;">SAVE (SALVAR)</button></div><button class="btn" style="background:#777; margin-top:10px;" onclick="toggleModal('dictModal')">Close</button><input type="hidden" id="saveF"></div></div>

<div id="citeModal" class="modal"><div class="modal-content" style="max-width:650px; text-align:left;"><h3 style="border-bottom:1px solid #eee;">Generate Citation (Gerar ReferÃªncia)</h3><div style="max-height:60vh; overflow-y:auto;"><div style="margin-bottom:15px;"><label>ğŸ‡§ğŸ‡· ABNT</label><div id="citABNT" onclick="copyText(this)" style="background:#f1f2f6; padding:10px; cursor:pointer;">...</div></div><div style="margin-bottom:15px;"><label>âš•ï¸ VANCOUVER</label><div id="citVAN" onclick="copyText(this)" style="background:#f1f2f6; padding:10px; cursor:pointer;">...</div></div><div style="margin-bottom:15px;"><label>ğŸ‡ºğŸ‡¸ AMA</label><div id="citAMA" onclick="copyText(this)" style="background:#f1f2f6; padding:10px; cursor:pointer;">...</div></div><div style="margin-bottom:15px;"><label>ğŸ§  APA</label><div id="citAPA" onclick="copyText(this)" style="background:#f1f2f6; padding:10px; cursor:pointer;">...</div></div><div style="margin-bottom:15px;"><label>ğŸ“ HARVARD</label><div id="citHAR" onclick="copyText(this)" style="background:#f1f2f6; padding:10px; cursor:pointer;">...</div></div><div style="margin-bottom:15px;"><label>âš™ï¸ IEEE</label><div id="citIEEE" onclick="copyText(this)" style="background:#f1f2f6; padding:10px; cursor:pointer;">...</div></div><div style="margin-bottom:15px;"><label>ğŸ“– CHICAGO</label><div id="citCHI" onclick="copyText(this)" style="background:#f1f2f6; padding:10px; cursor:pointer;">...</div></div></div><button class="btn" style="background:#777; width:100%;" onclick="toggleModal('citeModal')">Close (Fechar)</button></div></div>
<div class="player"><button id="playBtn" class="btn" style="border-radius:50%; width:50px; position:fixed; bottom:20px; left:20px;" onclick="toggleModal('dictModal')">ğŸ”Š</button></div>
</body></html>
