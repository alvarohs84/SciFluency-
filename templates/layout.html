<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>{{ app_name }}</title>
<style>
:root { --primary: #2980b9; --sec: #2c3e50; --bg: #f5f6fa; --card: #fff; --highlight: #ffeaa7; }
body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--sec); margin: 0; padding-bottom: 80px; }
.header { background: var(--card); padding: 15px; display: flex; justify-content: space-between; border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 100; }
.container { padding: 20px; max-width: 800px; margin: 0 auto; }
.card { background: var(--card); padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 15px; }
.btn { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; text-decoration: none; display: inline-block; }
.btn-del { background: #e74c3c; padding: 5px 10px; font-size: 0.8em; }

/* LEITURA & KARAOKE */
.sentence-block { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; line-height: 1.6; }
.sentence-active { background: #e1f5fe; border-left: 5px solid var(--primary); }
.word-span { cursor: pointer; padding: 2px; border-radius: 3px; }
.word-span:hover { background: #dfe6e9; }
.word-active { background: var(--highlight); color: black; font-weight: bold; transform: scale(1.1); display: inline-block; }

/* NAVBAR FIXA NO RODAP√â */
.nav-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--card); border-top: 1px solid #ddd; display: flex; justify-content: space-around; padding: 10px 0; z-index: 200; }
.nav-item { text-align: center; color: var(--sec); text-decoration: none; font-size: 0.8em; }
.nav-item span { display: block; font-size: 1.5em; }

/* MODAL */
.modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 300; align-items: center; justify-content: center; }
.modal-content { background: white; padding: 25px; border-radius: 10px; width: 80%; max-width: 400px; text-align: center; }
input, textarea { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }

/* PRON√öNCIA */
.mic-btn { width: 80px; height: 80px; border-radius: 50%; background: var(--primary); color: white; font-size: 2em; border: none; margin: 20px; cursor: pointer; }
.mic-active { background: #e74c3c; animation: pulse 1s infinite; }
@keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(231,76,60,0.7); } 100% { box-shadow: 0 0 0 15px rgba(231,76,60,0); } }
</style>
<script>
let curAud = null, currentSpans = [], rate=1.0;

async function speak(text) {
    if(curAud) curAud.pause();
    document.querySelectorAll('.word-active').forEach(w => w.classList.remove('word-active'));
    
    // Remove tags HTML para o TTS
    const clean = text.replace(/<[^>]*>/g, "");
    
    const res = await fetch('/tts', {method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:'text='+encodeURIComponent(clean)+'&accent=com'});
    const blob = await res.blob();
    curAud = new Audio(URL.createObjectURL(blob));
    curAud.playbackRate = rate;
    
    // KARAOKE VISUAL
    if(currentSpans.length > 0) {
        let duration = 0;
        curAud.onloadedmetadata = () => {
            duration = curAud.duration;
            animateKaraoke(duration);
        };
    }
    curAud.play();
}

function animateKaraoke(duration) {
    let totalChars = currentSpans.map(s => s.innerText.length).reduce((a,b)=>a+b, 0);
    let timePerChar = (duration * 1000) / totalChars;
    let accumulatedTime = 0;
    
    currentSpans.forEach((span, i) => {
        let delay = accumulatedTime;
        let wordTime = span.innerText.length * timePerChar;
        setTimeout(() => {
            if(i>0) currentSpans[i-1].classList.remove('word-active');
            span.classList.add('word-active');
        }, delay);
        accumulatedTime += wordTime;
    });
    
    setTimeout(() => {
        if(currentSpans.length>0) currentSpans[currentSpans.length-1].classList.remove('word-active');
    }, duration * 1000);
}

function prepare(el) {
    document.querySelectorAll('.sentence-active').forEach(s => s.classList.remove('sentence-active'));
    el.classList.add('sentence-active');
    currentSpans = Array.from(el.querySelectorAll('.word-span'));
    speak(el.innerText);
}

function mineWord(e, w) {
    e.stopPropagation();
    if(curAud) curAud.pause();
    document.getElementById('dictModal').style.display = 'flex';
    document.getElementById('dictWord').innerText = w;
    document.getElementById('dictTrans').innerText = '...';
    fetch('/translate?w='+w).then(r=>r.json()).then(d => {
        document.getElementById('dictTrans').innerText = d.t;
        document.getElementById('saveFront').value = w;
        document.getElementById('saveBack').value = d.t;
    });
}

function saveCard() {
    const f = document.getElementById('saveFront').value;
    const b = document.getElementById('saveBack').value;
    fetch('/add_card', {method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:`front=${f}&back=${b}`})
    .then(() => { document.getElementById('dictModal').style.display='none'; alert('Salvo!'); });
}

// PRON√öNCIA
function startRec(target) {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR) return alert("Use Chrome");
    const rec = new SR(); rec.lang='en-US';
    const btn = document.getElementById('mic');
    rec.onstart = () => { btn.classList.add('mic-active'); };
    rec.onend = () => { btn.classList.remove('mic-active'); };
    rec.onresult = (e) => {
        const spoken = e.results[0][0].transcript.toLowerCase().replace(/[^a-z]/g, '');
        const cleanT = target.toLowerCase().replace(/[^a-z]/g, '');
        document.getElementById('fb').innerHTML = (spoken == cleanT) ? "‚úÖ PERFEITO!" : `‚ùå Ouvi: ${spoken}`;
    };
    rec.start();
}
</script>
</head>
<body>

<div class="header">
    <h3>{{ app_name }}</h3>
    <a href="/novo" class="btn">+ Novo</a>
</div>

{% if mode == 'home' %}
<div class="container">
    <div class="card" style="text-align:center; background:#e1f5fe;">
        <h2>{{ vocab_count }}</h2>
        <small>Palavras Aprendidas</small>
        <br><br>
        <a href="/vocab" class="btn">Revisar Agora</a>
    </div>
    <h3>Meus Textos</h3>
    {% for s in stories %}
    <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
        <div onclick="window.location.href='/ler/{{s.id}}'" style="cursor:pointer; flex:1;">
            <b>{{ s.title }}</b><br>
            <small>{{ s.sentences|length }} frases</small>
        </div>
        <a href="/delete_story/{{s.id}}" class="btn-del">X</a>
    </div>
    {% endfor %}
</div>

{% elif mode == 'read' %}
<div class="container">
    <h3>{{ story.title }}</h3>
    {% for s in story.sentences %}
    <div class="sentence-block" onclick="prepare(this)">
        {% for w in s.en.split() %}
        <span class="word-span" onclick="mineWord(event, '{{w|replace("'","")|replace(".","")}}')">{{w}}</span>
        {% endfor %}
        <br><small style="color:#7f8c8d">{{ s.pt }}</small>
    </div>
    {% endfor %}
</div>

{% elif mode == 'vocab' %}
<div class="container">
    {% for c in cards %}
    <div class="card" style="display:flex; justify-content:space-between;">
        <div onclick="speak('{{c.front}}')">
            <b>{{c.front}}</b> <span style="color:#2980b9">{{c.ipa}}</span><br>
            <small>{{c.back}}</small>
        </div>
        <a href="/delete_card/{{c.id}}" style="color:red;">X</a>
    </div>
    {% endfor %}
</div>

{% elif mode == 'pronunciation' %}
<div class="container" style="text-align:center;">
    <script>const words = {{ words_json | safe }}; let idx=0;</script>
    <div class="card" style="padding:40px;">
        <h1 id="pWord">Ready?</h1>
        <p id="pIpa" style="color:#2980b9">...</p>
        <button id="mic" class="mic-btn" onclick="startRec(document.getElementById('pWord').innerText)">üé§</button>
        <h3 id="fb">Toque e Fale</h3>
        <br>
        <button class="btn" onclick="let w=words[Math.floor(Math.random()*words.length)]; document.getElementById('pWord').innerText=w.w; document.getElementById('pIpa').innerText=w.ipa; document.getElementById('fb').innerText='...';">Pr√≥xima ‚û°</button>
    </div>
</div>

{% elif mode == 'new' %}
<div class="container">
    <div class="card">
        <h3>Adicionar Material</h3>
        <form action="/novo" method="POST" enctype="multipart/form-data">
            <label>Op√ß√£o A: Colar Texto</label>
            <textarea name="text_input" rows="5" placeholder="English text here..."></textarea>
            <hr>
            <label>Op√ß√£o B: Enviar PDF</label>
            <input type="file" name="file_input" accept=".pdf">
            <br><br>
            <button class="btn" style="width:100%">PROCESSAR E ESTUDAR</button>
        </form>
    </div>
</div>
{% endif %}

<div id="dictModal" class="modal">
    <div class="modal-content">
        <h2 id="dictWord">...</h2>
        <p id="dictTrans">...</p>
        <input type="hidden" id="saveFront">
        <input type="hidden" id="saveBack">
        <button class="btn" onclick="saveCard()">Salvar Flashcard</button>
        <br><br>
        <button class="btn" style="background:#7f8c8d" onclick="document.getElementById('dictModal').style.display='none'">Fechar</button>
    </div>
</div>

<div class="nav-bar">
    <a href="/" class="nav-item"><span>üè†</span>Home</a>
    <a href="/novo" class="nav-item"><span>‚ûï</span>Novo</a>
    <a href="/pronunciation" class="nav-item"><span>üé§</span>Falar</a>
    <a href="/vocab" class="nav-item"><span>üóÇÔ∏è</span>Vocab</a>
</div>

</body></html>
